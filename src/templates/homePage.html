<!DOCTYPE html>
<html lang="en">
<head>
    PROVARE AD USARE AJAX
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donatos</title>
    <link rel="icon" type="image/x-icon" href="../static/img/icona.jpg">
    <link rel="stylesheet" href="../static/css/styleHome.css">
</head>
<body>
    <script>
    if (!localStorage.getItem('donatos_username')) {
        window.location.href = 'index.html';
    }
    </script>
    <img src="../static/img/logo.jpg" alt="Logo" class="logo">
    <div class="username">
        <p id="welcome-user"></p>
        <button id="logout-btn" type="button">Logout</button>

    </div>
    <div id="aggiungiFrase">
        <button id="aggiungiFraseBtn" type="button">Aggiungi Frase</button>
    </div>
    <div id="frasi">
        <!-- caricheranno dinamicamente  le frasi -->   
    </div>
    <div style="text-align:center; margin-top:2rem;">
        <a href="esplora.html" class="explore-link">Vai alla pagina Esplora</a>
    </div>
    <script>
    // ottengo username loggato 
    const username = localStorage.getItem('donatos_username');

    document.getElementById('welcome-user').textContent = "Benvenuto " + donatos_username;
    let frasiUtente = [];
    // Logout
    document.getElementById('logout-btn').onclick = function() {
        localStorage.removeItem('donatos_username');
        window.location.href = 'index.html';
    };
    async function filtraFrasi() {
    try {
        const res = await fetch('http://10.0.196.5:5000/frasi');
        if (!res.ok) throw new Error('File non trovato o errore di rete');
        const frasi = await res.json();
        frasiUtente = []; // svuota l'array prima di riempirlo
        for (const frase of frasi) {
            if (frase.username === username) {
                frasiUtente.push(frase);
            }
        }
        frasiUtente = frasiUtente.slice().reverse(); // inverte l'array per mostrare le frasi pi√π recenti per prime
    } catch (error) {
        console.error('Errore nell\'apertura o lettura del file:', error);
    }
}
    async function  caricaFrasi(){
        filtraFrasi();
        const frasiDiv = document.getElementById('frasi');
        frasiDiv.innerHTML = '';
        if (frasiUtente.length === 0) {
            frasiDiv.innerHTML = '<p style="text-align:center;">Nessuna frase trovata.</p>';
        }
        else{
            for(const frase of frasiUtente){
                const fraseBox = document.createElement('div');
                const pFrase = document.createElement('p');
                pFrase.textContent = frase.frase;
                const pData = document.createElement('p');
                pData.textContent = 'Data: ' + frase.dataora;
                fraseBox.appendChild(pFrase);
                fraseBox.appendChild(pData);
                frasiDiv.appendChild(fraseBox);
            }   
        }
    }

    // Aggiungi frase
    document.getElementById('aggiungiFraseBtn').onclick = async function() {
        const testo = prompt('Inserisci la nuova frase:');
        if(testo && testo.trim().length > 0) {
            await fetch('http://10.0.196.5:5000/aggiungi_frase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, frase: testo })
            });
            caricaFrasi();
        }
    };

    // Carica le frasi all'avvio
    caricaFrasi();      
    </script>
</body>
</html>